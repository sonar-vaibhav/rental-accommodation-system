<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Dashboard - Brand</title>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css?h=cb606d99bb2418df19b6bc818b41e412">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    integrity="sha384-rbs5D5tfFdhx3GkiJc7C5n5lL6LeX5f/bYlA8abzIq8DLrXCn1M5QC4Fv81t2Qb" crossorigin="anonymous">

  <!-- Bootstrap JS Bundle (including Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofNlq4zfu7lF+8XON1SzVHgWfE8i1qJ6aS"
    crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/9cb56d4a06.js" crossorigin="anonymous"></script>

</head>

<body id="page-top">
  <div id="wrapper">
    <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
      <div class="container-fluid d-flex flex-column p-0"><a
          class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="index.html">
          <div class="sidebar-brand-icon rotate-n-15"></div>
          <div class="sidebar-brand-text mx-3"><span class="text-capitalize">EZRooms</span></div>
        </a>
        <hr class="sidebar-divider my-0">
        <ul class="navbar-nav text-light" id="accordionSidebar">
          <li class="nav-item"><a class="nav-link" href="index.php"><i class="fas fa-tachometer-alt"></i><span
                style="margin: -2px;margin-left: 6px;">Dashboard</span></a></li>
          <li class="nav-item"></li>
          <li class="nav-item"><a class="nav-link" href="manage%20room.php"><svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 -32 576 576" width="1em" height="1em"
                fill="currentColor"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                <path
                  d="M575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6H511.8L512.5 447.7C512.5 450.5 512.3 453.1 512 455.8V472C512 494.1 494.1 512 472 512H456C454.9 512 453.8 511.1 452.7 511.9C451.3 511.1 449.9 512 448.5 512H392C369.9 512 352 494.1 352 472V384C352 366.3 337.7 352 320 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5L575.8 255.5z">
                </path>
              </svg><span style="margin: -2px;margin-left: 6px;">Manage Rooms</span></a></li>

          <li class="nav-item"><a class="nav-link" href="user_mgmt.php"><svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 -64 640 640" width="1em" height="1em"
                fill="currentColor"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                <path
                  d="M592 288H576V212.7c0-41.84-30.03-80.04-71.66-84.27C456.5 123.6 416 161.1 416 208V288h-16C373.6 288 352 309.6 352 336v128c0 26.4 21.6 48 48 48h192c26.4 0 48-21.6 48-48v-128C640 309.6 618.4 288 592 288zM496 432c-17.62 0-32-14.38-32-32s14.38-32 32-32s32 14.38 32 32S513.6 432 496 432zM528 288h-64V208c0-17.62 14.38-32 32-32s32 14.38 32 32V288zM224 256c70.7 0 128-57.31 128-128S294.7 0 224 0C153.3 0 96 57.31 96 128S153.3 256 224 256zM320 336c0-8.672 1.738-16.87 4.303-24.7C308.6 306.6 291.9 304 274.7 304H173.3C77.61 304 0 381.7 0 477.4C0 496.5 15.52 512 34.66 512h301.7C326.3 498.6 320 482.1 320 464V336z">
                </path>
              </svg><span style="margin: -2px;margin-left: 6px;">User Management</span></a></li>
              <li class="nav-item"><a class="nav-link" href="logout.php"><i class="fa-solid fa-right-from-bracket"></i><span style="margin: -2px;margin-left: 6px;">Logout</span></a></li>
        </ul>
        <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle"
            type="button"></button></div>
      </div>
    </nav>
    <div class="d-flex flex-column" id="content-wrapper">
      <div id="content">
        <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
          <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop"
              type="button"><i class="fas fa-bars"></i></button>
            <ul class="navbar-nav flex-nowrap ms-auto">
              <li class="nav-item dropdown no-arrow">

              </li>
            </ul>
          </div>
        </nav>

        <div class="container-fluid">
          <div class="d-sm-flex justify-content-between align-items-center mb-4">
            <h3 class="text-dark mb-0">Manage Rooms</h3>
          </div>
        </div>

        <div class="row gy-4 row-cols-1 row-cols-md-2 row-cols-xl-3" style="margin: 0px;margin-left: 4px;">
          <?php
          include '../connection.php';
          // Assuming you have a function to fetch data from the database based on $tableName
          $roomData = fetchDataFromDatabase($conn, 'rooms');
          // Function to fetch data from the database based on $tableName
          function fetchDataFromDatabase($conn, $tableName)
          {
            // $owner_id = $_SESSION['user_id'];
            // Define the SQL query based on the $tableName
            $sql = "SELECT * FROM $tableName";

            // Execute the query
            $result = mysqli_query($conn, $sql);

            // Check if the query was successful
            if ($result) {
              // Fetch the data as an associative array
              $data = mysqli_fetch_all($result, MYSQLI_ASSOC);
              // Free the result se
              mysqli_free_result($result);
              // Return the fetched data
              return $data;
            } else {
              // If the query failed, you may want to handle the error or log it
              // For now, returning an empty array
              return [];
            }
          }
          ?>

          <!-- Display room data in the HTML card structure -->
          <?php foreach ($roomData as $room): ?>
            <div class="col">
              <div class="card" style="border-radius: 19px;">
                <!-- ... Rest of your HTML card structure ... -->
                <div class="card-body p-4" style="box-shadow: 0px 0px;">
                  <?php
                  $roomId = $room['room_id'];
                  $oId = $room['owner_id'];
                  $imageUrls = fetchImageUrls($conn, $roomId);
                  $carouselId = 'carousel-' . $roomId;
                  ?>

                  <div class="carousel slide" data-bs-ride="false" id="<?php echo $carouselId; ?>" style="margin-top: 0;">
                    <div class="carousel-inner">
                      <?php foreach ($imageUrls as $index => $imageUrl): ?>
                        <div class="carousel-item <?= ($index === 0) ? 'active' : ''; ?>">
                          <img height="300px" width="450px" class="w-100 d-block" src="<?php echo $imageUrl['img_path']; ?>"
                            alt="Room Image">
                        </div>
                      <?php endforeach; ?>
                    </div>

                    <div>
                      <a class="carousel-control-prev" href="#<?php echo $carouselId; ?>" role="button"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                        <span class="visually-hidden">Previous</span>
                      </a>
                      <a class="carousel-control-next" href="#<?php echo $carouselId; ?>" role="button"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                        <span class="visually-hidden">Next</span>
                      </a>
                    </div>

                    <ol class="carousel-indicators">
                      <?php foreach ($imageUrls as $index => $imageUrl): ?>
                        <li data-bs-target="#<?php echo $carouselId; ?>" data-bs-slide-to="<?= $index; ?>" <?= ($index === 0) ? 'class="active"' : ''; ?>></li>
                      <?php endforeach; ?>
                    </ol>
                  </div>

                  <?php
                  include '../connection.php';
                  // calling functions
                  $averageRating = getAverageRating($conn, $roomId);
                  $countRating = getCountRating($conn, $roomId);
                  $total_reports = getCountRating($conn, $roomId);
                  ?>

                  <div style="height: 31px;margin: 0;margin-left: 0;margin-top: 14px;">
                    <p class="d-inline-flex float-start"
                      style="margin: 0;margin-left: 0;margin-top: 0;margin-right: 3px;font-weight: bold;">
                      Date of Room Uploaded : </p>

                    <?php $originalDate = $room['room_upload_date']; // Replace this with your actual date variable
                    
                      // Create a DateTime object from the original date
                      $dateTime = new DateTime($originalDate);

                      // Format the date as "DD MM YYYY"
                      $formattedDate = $dateTime->format('d-m-Y');
                      ?>
                    <p class="d-inline-flex float-start" style="margin-top: 0;margin-left: 0;">
                      <?php echo ($formattedDate); ?>
                    </p>
                  </div>

                  <div style="height: 31px;margin: 0;margin-left: 0;margin-top: 14px;">
                    <p class="d-inline-flex float-start"
                      style="margin: 0;margin-left: 0;margin-top: 0;margin-right: 3px;font-weight: bold;">
                      Average Rating :&nbsp;
                    </p>
                    <span class="d-inline-flex float-start" style="margin-top: 0;margin-left: 0;">
                      <?php echo number_format($averageRating, 1); // Display the average rating with one decimal place ?>
                        &nbsp;
                      <i class="fas fa-star" style="color: #FFD43B;"></i>
                    </span>
                  </div>

                  <div style="height: 31px;margin: 0;margin-left: 0;margin-top: 14px;">
                    <p class="d-inline-flex float-start"
                      style="margin: 0;margin-left: 0;margin-top: 0;margin-right: 3px;font-weight: bold;">
                      Total Students Rated :&nbsp;
                    </p>
                    <p class="d-inline-flex float-start" style="margin-top: 0;margin-left: 0;">
                      <?php echo $countRating; // Display the average rating with one decimal place ?>
                    </p>
                  </div>

                  <div style="height: 31px;margin: 0;margin-left: 0;margin-top: 14px;">
                    <p class="d-inline-flex float-start"
                      style="margin: 0;margin-left: 0;margin-top: 0;margin-right: 3px;font-weight: bold;">
                      Total Views :&nbsp;
                    </p>
                    <p class="d-inline-flex float-start" style="margin-top: 0;margin-left: 0;">
                      <?php echo $room['room_views']; // Display the average rating with one decimal place ?>
                    </p>
                  </div>

                  <div style="height: 31px;margin: 0;margin-left: 0;margin-top: 14px;">
                    <p class="d-inline-flex float-start"
                      style="margin: 0;margin-left: 0;margin-top: 0;margin-right: 3px;font-weight: bold;">
                      Total Reports :&nbsp;
                    </p>
                    <p class="d-inline-flex float-start" style="margin-top: 0;margin-left: 0;">
                      <?php echo getCountReports($conn, $room['room_id']); // Display the average rating with one decimal place ?>
                    </p>
                  </div>

                  <div style="margin: 0;margin-left: 0;margin-top: 14px;">
                    <a class="btn btn-primary btn-sm" style="margin-top:10px"
                      href="reports.php?room_id=<?php echo $room['room_id']; ?>"  >
                      See Reports &nbsp;<i class="fas fa-flag"></i>
                    </a>

                    <button class="btn btn-primary btn-sm" style="margin-top:10px" data-bs-toggle="modal"
                      data-bs-target="#messageModal_<?php echo $roomId; ?>">
                      Send Message &nbsp;<i class="fas fa-envelope"></i>
                    </button>

                    <button class="btn btn-primary btn-sm" style="margin-top:10px" data-bs-toggle="modal"
                      data-bs-target="#replyModal_<?php echo $roomId; ?>">
                      See Reply &nbsp;<i class="fas fa-eye"></i>
                    </button>

                    <form action="" method="POST" style="display:contents;">
                      <input type="text" value="<?php echo $room['room_id']; ?>" name="del_id" hidden>
                      <button class="btn btn-danger btn-sm" type="submit" name="delete" style="margin-top: 10px;">Delete &nbsp;
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>

                    <div class="modal fade" id="messageModal_<?php echo $roomId; ?>" tabindex="-1"
                      aria-labelledby="editModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Write message to Room owner</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>

                          <div class="modal-body">
                            <?php
                            // Assuming $room is the associative array containing existing room details
                            $room = fetchRoomDetailsById($conn, $room['room_id']);
                            ?>
                            <!-- Add your form elements here for editing room details -->
                            <form method="POST" action="sendMsg.php">
                              <input type="text" value="<?php echo $roomId; ?>" name="room_id" hidden>
                              <div>
                                <?php
                                $sql = "SELECT owner_fname, owner_lname FROM owners WHERE owner_id = '$oId'";
                                $result = $conn->query($sql);
                                if ($result) {
                                  $row = $result->fetch_assoc();
                                  echo '<label class="form-label">To : ' . $row['owner_fname'] . " " . $row['owner_lname'] . '</label>';
                                }
                                ?>
                              </div>

                              <div>
                                <input hidden type="text" value="<?php echo $oId; ?>" name="owner_id">
                                <label class="form-label">Subject : </label>
                                <input type="text" class="form-control" name="subject" required>
                              </div>

                              <div>
                                <label class="form-label">Message : </label>
                                <textarea class="form-control" id="" rows="6" name="msg"></textarea>
                              </div>

                              <div class="col-12" style="margin-top:10px;">
                                <button class="btn btn-primary" type="submit" name="sendMsg">Send</button>
                              </div>
                            </form>
                          </div>

                        </div>
                      </div>
                    </div>

                    <div class="modal fade" id="replyModal_<?php echo $roomId; ?>" tabindex="-1"
                      aria-labelledby="editModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Replys made by Room Owner</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <table class="table my-0" id="dataTable">
                              <thead>
                                <tr>
                                  <th>Date</th>
                                  <th>Subject</th>
                                  <th>Message</th>
                                  <th>Reply</th>
                                </tr>
                              </thead>
                              <tbody>
                                <?php
                                include("../connection.php");
                                $sql = "SELECT * FROM messages WHERE room_id = '$roomId';";
                                $result = $conn->query($sql);
                                if (!$result) {
                                  die("Invalid Query");
                                }
                                $hasData = false;
                                while ($row = $result->fetch_assoc()) {
                                  $hasData = true;
                                  echo "
                                      <tr>
                                          <td>$row[msg_date]</td>
                                          <td>$row[msg_subject]</td>
                                          <td>$row[msg_text]</td>
                                          <td>$row[msg_reply]</td>
                                      </tr>
                                      ";
                                }

                                if (!$hasData) {
                                  echo "
                                        <tr>
                                            <td colspan='5'> <b> No Data Found </b> </td>
                                        </tr>
                                    ";
                                }

                                ?>
                              </tbody>
                            </table>
                          </div>

                        </div>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          <?php endforeach; ?>

          <?php
          // include '../connection.php';
          if (isset($_POST['delete'])) {

            $delRoom = $_POST['del_id'];

            $sql = "DELETE FROM rooms WHERE room_id = '$delRoom'";
            // Execute the SQL query
            $result = mysqli_query($conn, $sql);

            if ($result) {
              // Query executed successfully, handle success (e.g., redirect or display a success message)
              echo "
                            <script>
                            alert('Room deleted successfully!');
                            </script>
                            ";
            } else {
              // Query failed, handle error (e.g., display an error message)
              echo "Error deleting room: " . mysqli_error($your_database_connection);
            }
          }
          ?>

          <?php
          include '../connection.php';
          function fetchImageUrls($conn, $roomId)
          {
            $sql = "SELECT img_path FROM room_img WHERE room_id = '$roomId'";
            $result = mysqli_query($conn, $sql);

            if ($result) {
              $imageUrls = mysqli_fetch_all($result, MYSQLI_ASSOC);
              mysqli_free_result($result);
              return $imageUrls;
            } else {
              return [];
            }
          }

          function getAverageRating($conn, $roomId)
          {
            // Prepare the SQL query
            $sql = "SELECT AVG(rr_rating) AS average_rating FROM room_reviews WHERE room_id = '$roomId'";
            // Execute the query
            $result = mysqli_query($conn, $sql);

            // Check if the query was successful
            if ($result) {
              // Fetch the result as an associative array
              $row = mysqli_fetch_assoc($result);

              // Free the result set
              mysqli_free_result($result);

              // Return the average rating
              return $row['average_rating'];
            } else {
              // If the query failed, handle the error (you may log it or return an error message)
              return false;
            }
          }
          function getCountRating($conn, $roomId)
          {
            // Prepare the SQL query
            $sql = "SELECT COUNT(*) AS total_rating FROM room_reviews WHERE room_id = '$roomId'";
            // Execute the query
            $result = mysqli_query($conn, $sql);

            // Check if the query was successful
            if ($result) {
              // Fetch the result as an associative array
              $row = mysqli_fetch_assoc($result);

              // Free the result set
              mysqli_free_result($result);

              // Return the average rating
              return $row['total_rating'];
            } else {
              // If the query failed, handle the error (you may log it or return an error message)
              return false;
            }
          }

          function getCountReports($conn, $roomId)
          {
            // Prepare the SQL query
            $sql = "SELECT COUNT(*) AS total_reports FROM complaints WHERE room_id = '$roomId'";
            // Execute the query
            $result = mysqli_query($conn, $sql);

            // Check if the query was successful
            if ($result) {
              // Fetch the result as an associative array
              $row = mysqli_fetch_assoc($result);

              // Free the result set
              mysqli_free_result($result);

              // Return the average rating
              return $row['total_reports'];
            } else {
              // If the query failed, handle the error (you may log it or return an error message)
              return false;
            }
          }

          function fetchRoomDetailsById($conn, $roomId)
          {
            // Use prepared statements to prevent SQL injection
            $stmt = $conn->prepare("SELECT * FROM rooms WHERE room_id = ?");
            $stmt->bind_param("s", $roomId);
            $stmt->execute();
            $result = $stmt->get_result();

            // Fetch room details as an associative array
            $room = $result->fetch_assoc();

            // Close the prepared statement
            $stmt->close();

            return $room;
          }
          ?>
        </div>

      </div>
      <footer class="bg-white sticky-footer">
        <div class="container my-auto">
          <div class="text-center my-auto copyright"><span>Copyright © EZRooms 2023</span></div>
        </div>
      </footer>
    </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/script.min.js?h=bdf36300aae20ed8ebca7e88738d5267"></script>
</body>

</html>